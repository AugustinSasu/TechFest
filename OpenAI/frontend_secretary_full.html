<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Secretary Assistant</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
        .container { max-width: 650px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 24px; }
        h2 { text-align: center; }
        .chat-box { border: 1px solid #ddd; border-radius: 6px; background: #fafafa; min-height: 200px; max-height: 350px; overflow-y: auto; padding: 12px; margin-bottom: 16px; }
        .msg { margin: 8px 0; }
        .msg.user { text-align: right; color: #1976d2; }
        .msg.bot { text-align: left; color: #333; }
        .input-row { display: flex; gap: 8px; }
        input, select { flex: 1; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        button { padding: 8px 16px; border: none; border-radius: 4px; background: #1976d2; color: #fff; cursor: pointer; }
        button:disabled { background: #aaa; }
        .recommendations { margin: 12px 0; }
        .recommendation { background: #e3f2fd; border-radius: 4px; padding: 8px; margin: 4px 0; }
        .selected { border: 2px solid #1976d2; }
        .section { margin-bottom: 18px; }
        .hidden { display: none; }
        .success { color: green; }
        .error { color: #b71c1c; }
    </style>
</head>
<body>
<div class="container">
    <h2>AI Secretary Assistant</h2>
    <div id="summarySection" class="section" style="background:#f9fbe7; border:1px solid #dce775; border-radius:6px; padding:10px 14px; margin-bottom:18px; font-size:15px;"></div>
    <div class="chat-box" id="chatBox"></div>
    <form id="goalForm" autocomplete="off" class="section">
        <div class="input-row">
            <input type="text" id="goalInput" placeholder="Enter your business objective... (e.g. Increase sales for Passat in all regions in the next 60 days)" required />
            <button type="submit">Send</button>
        </div>
    </form>
    <div id="recommendations" class="recommendations section"></div>
    <div id="messageSection" class="section hidden">
        <label for="styleSelect">Message style:</label>
        <select id="styleSelect">
            <option value="friendly">Friendly</option>
            <option value="professional">Professional</option>
            <option value="motivational">Motivational</option>
        </select>
        <label for="performanceSelect" style="margin-left:12px;">Performance level:</label>
        <select id="performanceSelect">
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
        </select>
        <button id="generateMsgBtn">Generate Team Message</button>
    </div>
    <div id="finalMessage" class="section"></div>
    <div id="reviewSection" class="section hidden">
        <h4>Send Review/Feedback</h4>
        <div class="input-row">
            <input type="number" id="managerIdInput" placeholder="Manager ID" min="1" required />
            <input type="number" id="salespersonIdInput" placeholder="Salesperson ID" min="1" required />
        </div>
        <textarea id="reviewTextInput" rows="3" style="width:100%;margin-top:8px;" placeholder="Review/Feedback text..." required readonly></textarea>
        <div style="margin-top:8px; display:flex; gap:8px;">
            <button id="approveReviewBtn">Approve</button>
            <button id="redoReviewBtn">Redo</button>
            <button id="manualReviewBtn">Write Manually</button>
            <button id="sendReviewBtn" class="hidden">Send Review</button>
        </div>
        <div id="reviewResult"></div>
    </div>
</div>
<script>
// Set API_URL explicitly to FastAPI backend on port 1919
const API_URL = 'http://localhost:1919';
const summarySection = document.getElementById('summarySection');
const chatBox = document.getElementById('chatBox');
const goalForm = document.getElementById('goalForm');
const goalInput = document.getElementById('goalInput');
const horizonInput = document.getElementById('horizonInput');
const recommendationsDiv = document.getElementById('recommendations');
const messageSection = document.getElementById('messageSection');
const styleSelect = document.getElementById('styleSelect');
const performanceSelect = document.getElementById('performanceSelect');
const generateMsgBtn = document.getElementById('generateMsgBtn');
const finalMessageDiv = document.getElementById('finalMessage');
const reviewSection = document.getElementById('reviewSection');
const managerIdInput = document.getElementById('managerIdInput');
const salespersonIdInput = document.getElementById('salespersonIdInput');
const reviewTextInput = document.getElementById('reviewTextInput');
const sendReviewBtn = document.getElementById('sendReviewBtn');
const approveReviewBtn = document.getElementById('approveReviewBtn');
const redoReviewBtn = document.getElementById('redoReviewBtn');
const manualReviewBtn = document.getElementById('manualReviewBtn');
// Approve: trimite review-ul generat automat
approveReviewBtn.onclick = (e) => {
    e.preventDefault();
    reviewTextInput.readOnly = true;
    sendReviewBtn.classList.remove('hidden');
    approveReviewBtn.disabled = true;
    redoReviewBtn.disabled = true;
    manualReviewBtn.disabled = true;
};

// Redo: regenerează mesajul (reapelează generateMsgBtn.onclick)
redoReviewBtn.onclick = async (e) => {
    e.preventDefault();
    approveReviewBtn.disabled = true;
    redoReviewBtn.disabled = true;
    manualReviewBtn.disabled = true;
    await generateMsgBtn.onclick();
    reviewTextInput.readOnly = true;
    approveReviewBtn.disabled = false;
    redoReviewBtn.disabled = false;
    manualReviewBtn.disabled = false;
    sendReviewBtn.classList.add('hidden');
};

// Write Manually: permite editarea manuală a review-ului
manualReviewBtn.onclick = (e) => {
    e.preventDefault();
    reviewTextInput.readOnly = false;
    sendReviewBtn.classList.remove('hidden');
    approveReviewBtn.disabled = true;
    redoReviewBtn.disabled = true;
    manualReviewBtn.disabled = true;
};
const reviewResult = document.getElementById('reviewResult');

let lastGoal = '';
let lastHorizon = 30;
let recs = [];
let selectedRecs = [];
let lastMessage = '';

function addMsg(text, sender) {
    const div = document.createElement('div');
    div.className = 'msg ' + sender;
    div.textContent = text;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
}

goalForm.onsubmit = async (e) => {
    e.preventDefault();
    const goal = goalInput.value.trim();
    if (!goal) return;
    addMsg(goal, 'user');
        // Send the business objective to summary for context/filtering
        addMsg('Objective accepted! Loading data summary...', 'bot');
        summarySection.innerHTML = 'Loading data summary...';
        // Extract period from objective (e.g. "last 600 days")
        let horizon = 30;
        const match = goal.match(/(\d+)\s*(day|zile|zi|days)/i);
        if (match) horizon = parseInt(match[1]);
        try {
            const summary = await fetch(API_URL + '/data_summary', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ goal, horizon })
            }).then(r => r.json());
            let html = '<b>Business Data Summary (AI):</b><br>';
            if (summary.ai_summary) {
                html += `<div style="margin-top:8px; white-space:pre-line;">${summary.ai_summary}</div>`;
            } else {
                html += '<span style="color:red">No summary available.</span>';
            }
            summarySection.innerHTML = html;
        } catch (e) {
            summarySection.innerHTML = '<span style="color:#b71c1c">Could not load data summary.</span>';
        }
    addMsg('Generating recommendations...', 'bot');
    lastGoal = goal;
    // 3. Get recommendations
    const recRes = await fetch(API_URL + '/recommendations', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ goal, horizon })
    }).then(r => r.json());
    recs = recRes.recommendations || [];
    recommendationsDiv.innerHTML = '<b>Select recommendations for the team:</b>';
    recs.forEach((rec, idx) => {
        const div = document.createElement('div');
        div.className = 'recommendation';
        div.innerHTML = `<input type="checkbox" value="${idx}" /> <b>${rec.title}</b><br><small>${rec.explanation}</small>`;
        recommendationsDiv.appendChild(div);
    });
    messageSection.classList.remove('hidden');
    finalMessageDiv.innerHTML = '';
    reviewSection.classList.add('hidden');
};

generateMsgBtn.onclick = async () => {
    // Collect selected recommendations
    const checkboxes = recommendationsDiv.querySelectorAll('input[type=checkbox]');
    selectedRecs = [];
    checkboxes.forEach((cb, idx) => { if (cb.checked) selectedRecs.push(idx); });
    if (selectedRecs.length === 0) {
        addMsg('Select at least one recommendation!', 'bot');
        return;
    }
    addMsg('Generating team message...', 'bot');
    const style = styleSelect.value;
    const performance_level = performanceSelect.value;
    const msgRes = await fetch(API_URL + '/compose_message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ goal: lastGoal, horizon: lastHorizon, selected: selectedRecs, style, performance_level })
    }).then(r => r.json());
    lastMessage = msgRes.message;
    finalMessageDiv.innerHTML = `<b>Team Message:</b><br><pre>${msgRes.message}</pre>`;
    addMsg('Team message generated below.', 'bot');
    reviewSection.classList.remove('hidden');
    reviewTextInput.value = msgRes.message;
};

sendReviewBtn.onclick = async (e) => {
    e.preventDefault();
    const manager_id = parseInt(managerIdInput.value.trim());
    const salesperson_id = parseInt(salespersonIdInput.value.trim());
    const review_text = reviewTextInput.value.trim();
    if (!manager_id || !salesperson_id || !review_text) {
        reviewResult.innerHTML = '<span class="error">All fields are required!</span>';
        return;
    }
    reviewResult.innerHTML = 'Sending...';
    const res = await fetch(API_URL + '/send_review', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ manager_id, salesperson_id, review_text })
    }).then(r => r.json());
    if(res.success) {
        reviewResult.innerHTML = '<span class="success">' + res.msg + '</span>';
        sendReviewBtn.classList.add('hidden');
        approveReviewBtn.disabled = false;
        redoReviewBtn.disabled = false;
        manualReviewBtn.disabled = false;
        reviewTextInput.readOnly = true;
    } else {
        reviewResult.innerHTML = '<span class="error">' + res.msg + '</span>';
    }
};
</script>
</body>
</html>
