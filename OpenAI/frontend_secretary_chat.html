<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Secretary Chat</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
        .container { max-width: 650px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 24px; }
        h2 { text-align: center; }
        .chat-box { border: 1px solid #ddd; border-radius: 6px; background: #fafafa; min-height: 300px; max-height: 500px; overflow-y: auto; padding: 12px; margin-bottom: 16px; }
        .msg { margin: 8px 0; }
        .msg.user { text-align: right; color: #1976d2; }
        .msg.bot { text-align: left; color: #333; }
        .input-row { display: flex; gap: 8px; }
        input, button { flex: 1; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        button { background: #1976d2; color: #fff; cursor: pointer; }
        button:disabled { background: #aaa; }
        .section { margin-bottom: 18px; }
        .success { color: green; }
        .error { color: #b71c1c; }
        .recommendation-list { margin: 8px 0 8px 16px; }
    </style>
</head>
<body>
<div class="container">
    <h2>AI Secretary Chat</h2>
    <div class="chat-box" id="chatBox"></div>
    <form id="chatForm" autocomplete="off" class="section">
        <div class="input-row">
            <input type="text" id="chatInput" placeholder="Type your message..." required />
            <button type="submit">Send</button>
        </div>
    </form>
</div>
<script>
const API_URL = 'http://localhost:1919';
const chatBox = document.getElementById('chatBox');
const chatForm = document.getElementById('chatForm');
const chatInput = document.getElementById('chatInput');

// State
let state = {
    step: 'goal', // goal, recs, style, perf, message, review
    lastGoal: '',
    lastHorizon: 30,
    recommendations: [],
    selectedRecs: [],
    style: 'friendly',
    performance_level: 'medium',
    message: '',
    manager_id: '',
    salesperson_id: '',
    review_approved: false
};

function addMsg(text, sender) {
    const div = document.createElement('div');
    div.className = 'msg ' + sender;
    div.innerHTML = text;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
}

function bot(text) { addMsg(text, 'bot'); }
function user(text) { addMsg(text, 'user'); }

function resetChat() {
    chatBox.innerHTML = '';
    state = { step: 'goal', lastGoal: '', lastHorizon: 30, recommendations: [], selectedRecs: [], style: 'friendly', performance_level: 'medium', message: '', manager_id: '', salesperson_id: '', review_approved: false };
    bot('Welcome! Please enter your business objective.');
}

resetChat();

chatForm.onsubmit = async (e) => {
    e.preventDefault();
    const input = chatInput.value.trim();
    if (!input) return;
    user(input);
    chatInput.value = '';
    await handleInput(input);
};

async function handleInput(input) {
    if (state.step === 'goal') {
        state.lastGoal = input;
        bot('Processing your objective...');
        // 1. Get summary
        try {
            bot('Loading business data summary...');
            const summaryRes = await fetch(API_URL + '/data_summary', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ goal: state.lastGoal, horizon: state.lastHorizon })
            }).then(r => r.json());
            if (summaryRes && summaryRes.ai_summary) {
                bot('<b>Business Data Summary (AI):</b><br><div style="white-space:pre-line;">' + summaryRes.ai_summary + '</div>');
            } else {
                bot('<span style="color:red">No summary available.</span>');
            }
        } catch (e) {
            bot('<span style="color:#b71c1c">Could not load data summary.</span>');
        }
        // 2. Get recommendations
        bot('Generating recommendations...');
        const recRes = await fetch(API_URL + '/recommendations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ goal: state.lastGoal, horizon: state.lastHorizon })
        }).then(r => r.json());
        state.recommendations = recRes.recommendations || [];
        if (!state.recommendations.length) {
            bot('No recommendations found. Please try another objective.');
            state.step = 'goal';
            return;
        }
        let recList = '<b>Available recommendations:</b><div class="recommendation-list">';
        state.recommendations.forEach((rec, i) => {
            recList += `<div>${i+1}. <b>${rec.title}</b><br><span style='font-size:13px;'>${rec.explanation}</span></div>`;
        });
        recList += '</div>';
        bot(recList + 'Reply with the numbers of the recommendations you want (e.g. 1,3).');
        state.step = 'recs';
        return;
    }
    if (state.step === 'recs') {
        // Parse selection
        const nums = input.split(',').map(x => parseInt(x.trim())-1).filter(x => !isNaN(x) && x >= 0 && x < state.recommendations.length);
        if (!nums.length) {
            bot('Please reply with valid numbers separated by commas (e.g. 1,2).');
            return;
        }
        state.selectedRecs = nums;
        bot('Now specify the message style (friendly, professional, motivational) and performance level (high, medium, low) in one line, e.g.: style: motivational, performance: high');
        state.step = 'style_perf';
        return;
    }
    if (state.step === 'style_perf') {
        // Parse style and performance
        let styleMatch = input.match(/style\s*:\s*(friendly|professional|motivational)/i);
        let perfMatch = input.match(/performance\s*:\s*(high|medium|low)/i);
        if (styleMatch) state.style = styleMatch[1].toLowerCase();
        if (perfMatch) state.performance_level = perfMatch[1].toLowerCase();
        if (!styleMatch || !perfMatch) {
            bot('Please specify both style and performance, e.g.: style: professional, performance: low');
            return;
        }
        bot('Generating team message...');
        // Compose message
        const msgRes = await fetch(API_URL + '/compose_message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ goal: state.lastGoal, horizon: state.lastHorizon, selected: state.selectedRecs, style: state.style, performance_level: state.performance_level })
        }).then(r => r.json());
        state.message = msgRes.message;
        bot('<b>Team Message:</b><br><pre>' + state.message + '</pre>');
        bot('Type "accept" to approve, "redo" to regenerate, or "manual" to write your own message.');
        state.step = 'review';
        return;
    }
    if (state.step === 'review') {
        if (input.toLowerCase() === 'accept') {
            bot('Please enter your manager ID and salesperson ID separated by comma (e.g. 1,2):');
            state.review_approved = true;
            state.step = 'ids';
            return;
        }
        if (input.toLowerCase() === 'redo') {
            bot('Regenerating message. Please re-enter style and performance (e.g. style: friendly, performance: medium)');
            state.step = 'style_perf';
            return;
        }
        if (input.toLowerCase() === 'manual') {
            bot('Please write your custom message.');
            state.step = 'manual';
            return;
        }
        bot('Type "accept", "redo", or "manual".');
        return;
    }
    if (state.step === 'manual') {
        state.message = input;
        bot('Please enter your manager ID and salesperson ID separated by comma (e.g. 1,2):');
        state.review_approved = true;
        state.step = 'ids';
        return;
    }
    if (state.step === 'ids') {
        const ids = input.split(',').map(x => parseInt(x.trim()));
        if (ids.length !== 2 || ids.some(isNaN)) {
            bot('Please enter two valid numbers separated by comma (e.g. 1,2).');
            return;
        }
        state.manager_id = ids[0];
        state.salesperson_id = ids[1];
        bot('Sending review...');
        const res = await fetch(API_URL + '/send_review', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ manager_id: state.manager_id, salesperson_id: state.salesperson_id, review_text: state.message })
        }).then(r => r.json());
        bot('<span class="success">Review sent and saved!</span> Type "restart" to start a new conversation.');
        state.step = 'done';
        return;
    }
    if (state.step === 'done') {
        if (input.toLowerCase() === 'restart') {
            resetChat();
            return;
        }
        bot('Type "restart" to start again.');
        return;
    }
}
</script>
</body>
</html>
